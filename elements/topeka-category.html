<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="topeka-category-front-page.html">
<link rel="import" href="topeka-quizzes.html">
<link rel="import" href="topeka-results.html">
<link rel="import" href="topeka-user-score.html">
<link rel="import" href="../components/core-pages/core-pages.html">

<polymer-element name="topeka-category" attributes="user category selected narrow" vertical layout>
<template>

  <link rel="stylesheet" href="topeka-category-themes.css">
  
  <core-pages selected="{{selected}}" hero-id="punch" hero class="{{category.theme}}-theme" flex>
  
    <topeka-category-front-page name="front" hero category="{{category}}" on-previous="{{mainAction}}" on-next="{{showQuizzes}}"></topeka-category-front-page>
  
    <topeka-quizzes name="quizzes" scores="{{scores}}" category="{{category}}" avatar="{{user.avatar}}" narrow="{{narrow}}"></topeka-quizzes>
    
    <topeka-results name="results" scores="{{scores}}" category="{{category}}" avatar="{{user.avatar}}" on-next="{{showScores}}"></topeka-results>
  
    <topeka-user-score name="scores" user="{{user}}" scores="{{scores}}" on-next="{{mainAction}}"></topeka-user-score>
    
  </core-pages>
  
</template>
<script>

  Polymer('topeka-category', {
    
    selected: 'front',
    narrow: false,
    
    computed: {
      'scores': 'computeScores(user, category, dirty)'
    },
    
    computeScores: function(user, category) {
      if (user && category) {
        if (!user.scores) {
          user.scores = {};
        }
        var n = category.name;
        return user.scores[n] = user.scores[n] || [];
      } else {
        return null;
      }
    },
    
    scoresChanged: function() {
      if (this.scores) {
        var l = this.scores.length;
        this.selected = l ? (l < this.category.quizzes.length ? 
            'quizzes' : 'results') : 'front';
      }
    },
    
    selectedChanged: function() {
      if (this.selected === 'results') {
        this.fire('results');
      }
    },
    
    showQuizzes: function() {
      this.selected = 'quizzes';
    },
    
    showScores: function() {
      this.selected = 'scores';
    },
    
    mainAction: function() {
      this.fire('main');
    }
    
  });

</script>
</polymer-element>